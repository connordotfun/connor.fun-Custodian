- name: Prepare AWS environment for connor.fun storm network
  hosts: local
  
  vars_files:
    - vars/keys.yaml
    - vars/security_groups.yaml
    - vars/machines.yaml
    - vars/config.yaml

  tasks:

    # ==== Begin Rule and Key Generation ====

    - name: Create necessary security group for cluster
      ec2_group:
        aws_access_key: "{{ aws_auth.access }}"
        aws_secret_key: "{{ aws_auth.secret }}"
        name: "{{ item.name }}"
        description: "{{ item.description }}"
        region: "{{ region }}"
        rules: "{{ item.rules }}"
        tags: "{{ item.tags }}"
      loop: "{{ security_groups }}"
      register: Security_Response

    - name: Make log of security group creation
      copy: 
        content: "{{ Security_Response | to_nice_json }}"
        dest: logs/Security_Group_generation.log

    - name: Create ssh key for machines
      ec2_key:
        aws_access_key: "{{ aws_auth.access }}"
        aws_secret_key: "{{ aws_auth.secret }}"
        name: "{{ ssh_key_name }}"
        region: "{{ region }}"
      register: SSHKey_Response

    - name: Make log of sshkey generation
      copy: 
        content: "{{ SSHKey_Response | to_nice_json }}"
        dest: logs/SSHKey_generation.log

    - name: Save .pem file to local directory
      copy: 
        content: "{{ SSHKey_Response['key']['private_key'] }}"
        dest: "{{ ssh_key_name + '.pem' }}"